<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Validation Map - BRFSS</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        nav {
            background: #1e3a5f;
            padding: 15px 20px;
            margin-bottom: 30px;
        }
        nav ul {
            list-style: none;
            display: flex;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        nav a:hover, nav a.active { background: rgba(255,255,255,0.1); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { margin-bottom: 10px; color: #1e3a5f; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .stats-bar { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-card {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
        }
        .stat-card.passed { border-left: 4px solid #22c55e; }
        .stat-card.with-errors { border-left: 4px solid #f59e0b; }
        .stat-card.failed { border-left: 4px solid #ef4444; }
        .stat-card.pending { border-left: 4px solid #6b7280; }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #1e3a5f; }
        .stat-label { color: #666; font-size: 0.9em; }
        .map-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        #us-map { width: 100%; height: auto; }
        .state { fill: #d1d5db; stroke: #fff; stroke-width: 1; cursor: pointer; transition: all 0.2s; }
        .state:hover { opacity: 0.8; stroke-width: 2; stroke: #1e3a5f; }
        .state.passed { fill: #22c55e; }
        .state.failed { fill: #ef4444; }
        .legend { display: flex; gap: 30px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
        .legend-color.passed { background: #22c55e; }
        .legend-color.failed { background: #ef4444; }
        .legend-color.pending { background: #d1d5db; }
        .tooltip {
            position: absolute;
            background: #1e3a5f;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        .state-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .state-list h3 { margin-bottom: 20px; color: #1e3a5f; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn:hover, .filter-btn.active { background: #1e3a5f; color: white; border-color: #1e3a5f; }
        .state-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .state-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }
        .state-badge { width: 12px; height: 12px; border-radius: 50%; }
        .state-badge.passed { background: #22c55e; }
        .state-badge.failed { background: #ef4444; }
        .upload-prompt { text-align: center; padding: 40px; color: #666; }
        .upload-prompt a { color: #1e3a5f; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .clear-btn {
            background: #dc3545; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: background 0.2s;
        }
        .clear-btn:hover { background: #c82333; }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white; padding: 30px; border-radius: 12px;
            max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal h3 { color: #dc3545; margin-bottom: 15px; }
        .modal p { color: #666; margin-bottom: 25px; }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; }
        .modal-btn {
            padding: 10px 25px; border-radius: 6px; border: none;
            cursor: pointer; font-size: 14px; font-weight: 500;
        }
        .modal-btn.cancel { background: #e9ecef; color: #333; }
        .modal-btn.cancel:hover { background: #dee2e6; }
        .modal-btn.confirm { background: #dc3545; color: white; }
        .modal-btn.confirm:hover { background: #c82333; }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/submit">Submit Data</a></li>
            <li><a href="/validation">Dashboard</a></li>
            <li><a href="/map" class="active">State Map</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <div>
                <h1>BRFSS Validation Status by State</h1>
                <p class="subtitle">Interactive map showing validation results for each state's submission</p>
            </div>
            <button onclick="clearDashboard()" class="clear-btn">Clear All Data</button>
        </div>

        <div class="stats-bar">
            <div class="stat-card passed">
                <div class="stat-number">{{ passed }}</div>
                <div class="stat-label">States Passed</div>
            </div>
            <div class="stat-card with-errors">
                <div class="stat-number">{{ passed_with_errors }}</div>
                <div class="stat-label">Passed with Errors</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-number">{{ failed }}</div>
                <div class="stat-label">States Failed</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-number">{{ 50 - total_states }}</div>
                <div class="stat-label">Pending Submission</div>
            </div>
        </div>

        <div class="map-container">
            <div id="us-map"></div>
            <div class="tooltip" id="tooltip"></div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color passed"></div><span>Passed</span></div>
                <div class="legend-item"><div class="legend-color failed"></div><span>Failed</span></div>
                <div class="legend-item"><div class="legend-color pending"></div><span>No Submission</span></div>
            </div>
        </div>

        {% if total_states == 0 %}
        <div class="upload-prompt">
            <h3>No state submissions yet</h3>
            <p>Upload state BRFSS data files to see validation results on the map.</p>
            <p><a href="/submit">Go to Submit Page</a></p>
        </div>
        {% else %}
        <div class="state-list">
            <h3>State Submission Details</h3>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterStates('all')">All ({{ total_states }})</button>
                <button class="filter-btn" onclick="filterStates('passed')">Passed ({{ passed }})</button>
                <button class="filter-btn" onclick="filterStates('failed')">Failed ({{ failed }})</button>
            </div>
            <div class="state-grid" id="state-grid">
                {% for abbr, details in state_details.items() %}
                <div class="state-item" data-status="{{ details.status }}">
                    <div class="state-badge {{ details.status }}"></div>
                    <div>
                        <strong>{{ abbr }}</strong>
                        <div style="font-size: 0.85em; color: #666;">{{ details.rows }} rows | {{ details.errors }} errors</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        const stateStatus = {{ state_status | tojson | safe }};
        const stateDetails = {{ state_details | tojson | safe }};

        const stateNames = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',
            'DC': 'District of Columbia'
        };

        const fipsToAbbr = {
            '01': 'AL', '02': 'AK', '04': 'AZ', '05': 'AR', '06': 'CA', '08': 'CO', '09': 'CT',
            '10': 'DE', '11': 'DC', '12': 'FL', '13': 'GA', '15': 'HI', '16': 'ID', '17': 'IL',
            '18': 'IN', '19': 'IA', '20': 'KS', '21': 'KY', '22': 'LA', '23': 'ME', '24': 'MD',
            '25': 'MA', '26': 'MI', '27': 'MN', '28': 'MS', '29': 'MO', '30': 'MT', '31': 'NE',
            '32': 'NV', '33': 'NH', '34': 'NJ', '35': 'NM', '36': 'NY', '37': 'NC', '38': 'ND',
            '39': 'OH', '40': 'OK', '41': 'OR', '42': 'PA', '44': 'RI', '45': 'SC', '46': 'SD',
            '47': 'TN', '48': 'TX', '49': 'UT', '50': 'VT', '51': 'VA', '53': 'WA', '54': 'WV',
            '55': 'WI', '56': 'WY'
        };

        const width = 960, height = 600;
        const svg = d3.select('#us-map')
            .append('svg')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');

        const tooltip = d3.select('#tooltip');
        const projection = d3.geoAlbersUsa().scale(1200).translate([width / 2, height / 2]);
        const path = d3.geoPath().projection(projection);

        d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(us => {
            const states = topojson.feature(us, us.objects.states).features;

            svg.selectAll('.state')
                .data(states)
                .enter()
                .append('path')
                .attr('class', d => {
                    const fips = String(d.id).padStart(2, '0');
                    const abbr = fipsToAbbr[fips];
                    const status = stateStatus[abbr] || '';
                    return `state ${status}`;
                })
                .attr('d', path)
                .attr('id', d => fipsToAbbr[String(d.id).padStart(2, '0')])
                .on('mouseover', (event, d) => {
                    const fips = String(d.id).padStart(2, '0');
                    const abbr = fipsToAbbr[fips];
                    const name = stateNames[abbr] || 'Unknown';
                    const details = stateDetails[abbr];

                    let html = `<strong>${name} (${abbr})</strong>`;
                    if (details) {
                        html += `<br>Status: ${details.status.replace('_', ' ')}`;
                        html += `<br>Rows: ${details.rows} | Errors: ${details.errors}`;
                    } else {
                        html += '<br>No submission yet';
                    }

                    tooltip.html(html)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px')
                        .style('opacity', 1);
                })
                .on('mouseout', () => tooltip.style('opacity', 0));
        });

        function filterStates(status) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.state-item').forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        setInterval(() => {
            fetch('/api/state-status')
                .then(r => r.json())
                .then(data => {
                    Object.entries(data).forEach(([abbr, details]) => {
                        const el = document.getElementById(abbr);
                        if (el) {
                            el.classList.remove('passed', 'failed');
                            el.classList.add(details.status);
                        }
                    });
                });
        }, 30000);

        function clearDashboard() {
            document.getElementById('clearModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('clearModal').classList.remove('show');
            document.getElementById('clearPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function confirmClear() {
            const password = document.getElementById('clearPassword').value;
            const errorEl = document.getElementById('passwordError');

            fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        errorEl.style.display = 'block';
                        return;
                    }
                    closeModal();
                    location.reload();
                })
                .catch(err => {
                    errorEl.style.display = 'block';
                });
        }

        document.getElementById('clearModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>

    <!-- Clear Confirmation Modal -->
    <div class="modal-overlay" id="clearModal">
        <div class="modal">
            <h3>Clear All Data?</h3>
            <p>This will permanently delete all submissions and validation results. This action cannot be undone.</p>
            <div style="margin-bottom: 20px;">
                <label for="clearPassword" style="display: block; text-align: left; margin-bottom: 5px; font-weight: 500; color: #333;">Enter password to confirm:</label>
                <input type="password" id="clearPassword" placeholder="Password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <p id="passwordError" style="color: #dc3545; font-size: 12px; margin-top: 5px; display: none;">Incorrect password</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmClear()">Yes, Clear All</button>
            </div>
        </div>
    </div>
</body>
</html>
